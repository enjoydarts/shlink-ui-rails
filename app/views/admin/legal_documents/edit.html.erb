<% content_for :title, @page_title %>

<!-- Font Awesome -->
<% content_for :head do %>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous">
  <style>
    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒœã‚¿ãƒ³ã®åŸºæœ¬è¨­å®š */
    .toolbar-btn {
      position: relative;
    }

    /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆçŠ¶æ…‹ï¼šFont Awesomeã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤ºã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ†ã‚­ã‚¹ãƒˆã¯éè¡¨ç¤º */
    .toolbar-btn i {
      display: inline-block !important;
    }
    .toolbar-btn .fallback-text {
      display: none !important;
    }

    /* Font AwesomeãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆï¼šã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤ºã€ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º */
    .toolbar-btn:not(.fa-loaded) i {
      display: none !important;
    }
    .toolbar-btn:not(.fa-loaded) .fallback-text {
      display: inline-block !important;
      font-size: 12px;
      font-weight: bold;
    }


    /* ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
    .toolbar-btn:hover {
      background-color: #e5e7eb !important;
      border-color: #9ca3af !important;
    }

    /* JavaScriptãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .js-tooltip {
      position: absolute;
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: normal;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      white-space: nowrap;
      z-index: 1000;
      pointer-events: none;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      line-height: 1.4;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .js-tooltip.show {
      opacity: 1;
    }

    .js-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      margin-left: -4px;
      border-width: 4px;
      border-style: solid;
      border-color: rgba(0, 0, 0, 0.9) transparent transparent transparent;
    }
  </style>
  <script>
    // Font AwesomeãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(function() {
        const testEl = document.createElement('i');
        testEl.className = 'fas fa-home';
        testEl.style.display = 'none';
        document.body.appendChild(testEl);

        const isLoaded = window.getComputedStyle(testEl, ':before').getPropertyValue('content') !== 'none';
        document.body.removeChild(testEl);

        if (!isLoaded) {
          // Font AwesomeãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ãªã„å ´åˆã€ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒœã‚¿ãƒ³ã«ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.classList.remove('fa-loaded');
          });
        } else {
          document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.classList.add('fa-loaded');
          });
        }
      }, 100);
    });
  </script>
<% end %>

<div class="mb-6">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2"><%= @page_title %></h1>
      <p class="text-gray-600">Markdownå½¢å¼ã§æ–‡æ›¸ã‚’ä½œæˆãƒ»ç·¨é›†ã§ãã¾ã™</p>
    </div>
    <div class="flex space-x-3">
      <%= link_to admin_legal_document_path(@document_type),
          class: "bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200",
          onclick: "return confirmLeave()" do %>
        ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      <% end %>
      <%= link_to admin_legal_documents_path,
          class: "bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200",
          onclick: "return confirmLeave()" do %>
        ä¸€è¦§ã«æˆ»ã‚‹
      <% end %>
    </div>
  </div>
</div>

<%= form_with model: @setting, url: admin_legal_document_path(@document_type), method: :patch, local: true, class: "space-y-6" do |form| %>
  <div class="bg-white rounded-lg shadow border border-gray-200">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="px-6 py-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">æ–‡æ›¸ç·¨é›†</h2>
        <div class="flex items-center space-x-4 text-sm text-gray-500">
          <span id="char-count">0 æ–‡å­—</span>
          <span id="word-count">0 èª</span>
        </div>
      </div>
    </div>

    <!-- ã‚·ãƒ³ãƒ—ãƒ«ãªã‚¨ãƒ‡ã‚£ã‚¿ -->
    <div class="p-6">
      <div class="mb-4">
        <div class="flex flex-wrap gap-1 p-2 bg-gray-50 rounded-t border border-gray-200">
          <!-- åŸºæœ¬è£…é£¾ -->
          <button type="button" onclick="event.preventDefault(); insertText('**', '**')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="å¤ªå­— (**æ–‡å­—**)">
            <i class="fas fa-bold text-sm"></i>
            <span class="fallback-text font-bold text-xs">B</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('*', '*')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="æ–œä½“ (*æ–‡å­—*)">
            <i class="fas fa-italic text-sm"></i>
            <span class="fallback-text italic text-xs">I</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('~~', '~~')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="å–æ¶ˆç·š (~~æ–‡å­—~~)">
            <i class="fas fa-strikethrough text-sm"></i>
            <span class="fallback-text text-xs line-through">S</span>
          </button>

          <div class="border-l border-gray-300 mx-1 self-stretch"></div>

          <!-- è¦‹å‡ºã— -->
          <button type="button" onclick="event.preventDefault(); insertText('# ', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="è¦‹å‡ºã—1 (# æ–‡å­—)">
            <i class="fas fa-heading text-sm"></i>
            <span class="fallback-text text-xs font-bold">H1</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('## ', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="è¦‹å‡ºã—2 (## æ–‡å­—)">
            <i class="fas fa-heading text-sm"></i>
            <span class="fallback-text text-xs font-bold">H2</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('### ', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="è¦‹å‡ºã—3 (### æ–‡å­—)">
            <i class="fas fa-heading text-sm"></i>
            <span class="fallback-text text-xs font-bold">H3</span>
          </button>

          <div class="border-l border-gray-300 mx-1 self-stretch"></div>

          <!-- ãƒªã‚¹ãƒˆ -->
          <button type="button" onclick="event.preventDefault(); insertText('- ', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ (- é …ç›®)">
            <i class="fas fa-list-ul text-sm"></i>
            <span class="fallback-text text-xs">â€¢</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('1. ', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="ç•ªå·ãƒªã‚¹ãƒˆ (1. é …ç›®)">
            <i class="fas fa-list-ol text-sm"></i>
            <span class="fallback-text text-xs">1.</span>
          </button>

          <div class="border-l border-gray-300 mx-1 self-stretch"></div>

          <!-- ãƒªãƒ³ã‚¯ãƒ»å¼•ç”¨ -->
          <button type="button" onclick="event.preventDefault(); insertText('[', '](URL)')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="ãƒªãƒ³ã‚¯ ([æ–‡å­—](URL))">
            <i class="fas fa-link text-sm"></i>
            <span class="fallback-text text-xs">ğŸ”—</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('> ', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="å¼•ç”¨ (> æ–‡å­—)">
            <i class="fas fa-quote-left text-sm"></i>
            <span class="fallback-text text-xs">"</span>
          </button>

          <div class="border-l border-gray-300 mx-1 self-stretch"></div>

          <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ»åŒºåˆ‡ã‚Šç·š -->
          <button type="button" onclick="event.preventDefault(); insertTable()"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="è¡¨ã‚’æŒ¿å…¥">
            <i class="fas fa-table text-sm"></i>
            <span class="fallback-text text-xs">âŠ</span>
          </button>
          <button type="button" onclick="event.preventDefault(); insertText('\\n---\\n', '')"
                  class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded hover:bg-gray-100 toolbar-btn"
                  title="åŒºåˆ‡ã‚Šç·š (---)">
            <i class="fas fa-minus text-sm"></i>
            <span class="fallback-text text-xs">â€”</span>
          </button>
        </div>
      </div>

      <div class="relative">
        <%= form.text_area :value,
            value: @content,
            id: "markdown-editor",
            class: "w-full h-96 p-4 border border-gray-200 rounded-b font-mono text-sm leading-relaxed focus:border-blue-500 focus:ring-1 focus:ring-blue-500",
            placeholder: "Markdownå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„..." %>

      </div>
    </div>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="px-6 pb-4">
      <div class="bg-blue-50 border border-blue-200 rounded-md p-4">
        <div class="flex">
          <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <div class="ml-3">
            <h3 class="text-sm font-medium text-blue-800">Markdownã‚¬ã‚¤ãƒ‰</h3>
            <div class="mt-2 text-sm text-blue-700">
              <ul class="list-disc list-inside space-y-1">
                <li><strong># è¦‹å‡ºã—1</strong>, <strong>## è¦‹å‡ºã—2</strong> - è¦‹å‡ºã—ã‚’ä½œæˆ</li>
                <li><strong>**å¤ªå­—**</strong>, <strong>*æ–œä½“*</strong> - ãƒ†ã‚­ã‚¹ãƒˆã®è£…é£¾</li>
                <li><strong>- ãƒªã‚¹ãƒˆ</strong>, <strong>1. ç•ªå·ä»˜ããƒªã‚¹ãƒˆ</strong> - ãƒªã‚¹ãƒˆã‚’ä½œæˆ</li>
                <li><strong>[ãƒªãƒ³ã‚¯ãƒ†ã‚­ã‚¹ãƒˆ](URL)</strong> - ãƒªãƒ³ã‚¯ã‚’ä½œæˆ</li>
                <li><strong>`ã‚³ãƒ¼ãƒ‰`</strong> - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 rounded-b-lg">
      <div class="flex items-center justify-between">
        <div class="flex space-x-3">
          <%= link_to admin_legal_documents_path,
              class: "bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200" do %>
            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          <% end %>
        </div>
        <div class="flex space-x-3">
          <button type="button"
                  onclick="loadTemplate()"
                  class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md text-sm font-medium transition-colors duration-200">
            ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
          </button>
          <%= form.submit "ä¿å­˜",
              class: "bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-md text-sm font-medium transition-colors duration-200" %>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
// ã‚·ãƒ³ãƒ—ãƒ«ãªMarkdownã‚¨ãƒ‡ã‚£ã‚¿æ©Ÿèƒ½
const editor = document.getElementById('markdown-editor');

// ãƒ†ã‚­ã‚¹ãƒˆæŒ¿å…¥æ©Ÿèƒ½
function insertText(before, after) {
  editor.focus(); // å…ˆã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å½“ã¦ã‚‹

  const start = editor.selectionStart;
  const end = editor.selectionEnd;
  const selectedText = editor.value.substring(start, end);
  const newText = before + selectedText + after;

  // ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥
  editor.value = editor.value.substring(0, start) + newText + editor.value.substring(end);

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’é©åˆ‡ã«è¨­å®š
  let newCursorPos;
  if (selectedText) {
    // ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ãŸå ´åˆã€æŒ¿å…¥ã—ãŸãƒ†ã‚­ã‚¹ãƒˆã®å¾Œã‚ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ã
    newCursorPos = start + newText.length;
  } else {
    // ãƒ†ã‚­ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã€beforeã¨afterã®é–“ã«ã‚«ãƒ¼ã‚½ãƒ«ã‚’ç½®ã
    newCursorPos = start + before.length;
  }

  editor.setSelectionRange(newCursorPos, newCursorPos);
  editor.focus(); // å†åº¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹

  updateCounts();
}

// ãƒ†ãƒ¼ãƒ–ãƒ«æŒ¿å…¥æ©Ÿèƒ½
function insertTable() {
  const tableText = '\\n| é …ç›® | å†…å®¹ |\\n|------|------|\\n| ä¾‹1 | èª¬æ˜1 |\\n| ä¾‹2 | èª¬æ˜2 |\\n\\n';
  const start = editor.selectionStart;

  editor.value = editor.value.substring(0, start) + tableText + editor.value.substring(start);
  editor.setSelectionRange(start + tableText.length, start + tableText.length);
  editor.focus();
  updateCounts();
}

// æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ
function updateCounts() {
  const text = editor.value;
  const charCount = text.length;
  const wordCount = text.split(/\s+/).filter(word => word.length > 0).length;

  document.getElementById('char-count').textContent = charCount + ' æ–‡å­—';
  document.getElementById('word-count').textContent = wordCount + ' èª';
}

// ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿
function loadTemplate() {
  if (confirm('ç¾åœ¨ã®å†…å®¹ã‚’ç ´æ£„ã—ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ')) {
    fetch('/admin/legal_documents/<%= @document_type %>/template')
      .then(response => response.text())
      .then(template => {
        editor.value = template;
        updateCounts();
      })
      .catch(error => {
        console.error('Template loading failed:', error);
        alert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
      });
  }
}

// ãƒšãƒ¼ã‚¸é›¢è„±ç¢ºèª
function confirmLeave() {
  const currentContent = editor.value;
  const originalContent = '<%= j(@content) %>';

  if (currentContent !== originalContent) {
    return confirm('ç·¨é›†å†…å®¹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ');
  }
  return true;
}

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—æ©Ÿèƒ½
function initTooltips() {
  const buttons = document.querySelectorAll('.toolbar-btn[title]');

  buttons.forEach(button => {
    button.addEventListener('mouseenter', function() {
      const title = this.getAttribute('title');
      if (!title) return;

      // æ—¢å­˜ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’å‰Šé™¤
      const existingTooltip = document.querySelector('.js-tooltip');
      if (existingTooltip) existingTooltip.remove();

      // æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ä½œæˆ
      const tooltip = document.createElement('div');
      tooltip.className = 'js-tooltip';
      tooltip.textContent = title;
      tooltip.style.position = 'fixed';
      tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
      tooltip.style.color = 'white';
      tooltip.style.padding = '8px 12px';
      tooltip.style.borderRadius = '6px';
      tooltip.style.fontSize = '14px';
      tooltip.style.whiteSpace = 'nowrap';
      tooltip.style.zIndex = '9999';
      tooltip.style.pointerEvents = 'none';
      tooltip.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.3)';

      document.body.appendChild(tooltip);

      // ä½ç½®ã‚’è¨ˆç®—
      const rect = this.getBoundingClientRect();
      const tooltipRect = tooltip.getBoundingClientRect();

      const left = rect.left + rect.width / 2 - tooltipRect.width / 2;
      const top = rect.top - tooltipRect.height - 8;

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
      tooltip.style.opacity = '1';
    });

    button.addEventListener('mouseleave', function() {
      const tooltip = document.querySelector('.js-tooltip');
      if (tooltip) tooltip.remove();
    });
  });
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
  updateCounts();
  editor.addEventListener('input', updateCounts);
  initTooltips();
});
</script>