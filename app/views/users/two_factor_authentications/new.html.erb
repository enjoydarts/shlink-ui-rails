<div class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-indigo-50 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 py-8 px-4">
  <div class="max-w-2xl mx-auto">
    <!-- Header Section -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 bg-orange-500 rounded-2xl mb-4 shadow-lg">
        <svg width="24" height="24" viewBox="0 0 24 24" class="text-white">
          <path fill="currentColor" d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C15.4,11.5 16,12.4 16,13V16C16,16.6 15.6,17 15,17H9C8.4,17 8,16.6 8,16V13C8,12.4 8.4,11.5 9,11.5V10C9,8.6 10.6,7 12,7M12,8.2C11.2,8.2 10.2,9.2 10.2,10V11.5H13.8V10C13.8,9.2 12.8,8.2 12,8.2Z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-2">二段階認証の設定</h1>
      <p class="text-lg text-gray-600 dark:text-gray-300">アカウントのセキュリティを向上させましょう</p>
    </div>

    <!-- Setup Steps -->
    <div class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl shadow-xl border border-white/20 dark:border-gray-700/30 p-6 lg:p-8 mb-8">
      
      <!-- Step 1: Install App -->
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">1</div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">認証アプリをインストール</h3>
        </div>
        <p class="text-gray-600 dark:text-gray-300 mb-4">以下のいずれかの認証アプリをスマートフォンにインストールしてください：</p>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-lg mx-auto mb-2 flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" class="text-blue-600">
                <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.41,10.09L6,11.5L11,16.5Z"/>
              </svg>
            </div>
            <h4 class="font-semibold text-gray-800 dark:text-gray-100">Google Authenticator</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">推奨</p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="w-12 h-12 bg-purple-100 rounded-lg mx-auto mb-2 flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" class="text-purple-600">
                <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.41,10.09L6,11.5L11,16.5Z"/>
              </svg>
            </div>
            <h4 class="font-semibold text-gray-800 dark:text-gray-100">Authy</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">推奨</p>
          </div>
          <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-4 text-center">
            <div class="w-12 h-12 bg-green-100 rounded-lg mx-auto mb-2 flex items-center justify-center">
              <svg width="24" height="24" viewBox="0 0 24 24" class="text-green-600">
                <path fill="currentColor" d="M12,2A10,10 0 0,1 22,12A10,10 0 0,1 12,22A10,10 0 0,1 2,12A10,10 0 0,1 12,2M11,16.5L18,9.5L16.59,8.09L11,13.67L7.41,10.09L6,11.5L11,16.5Z"/>
              </svg>
            </div>
            <h4 class="font-semibold text-gray-800 dark:text-gray-100">その他</h4>
            <p class="text-sm text-gray-600 dark:text-gray-300">TOTP対応アプリ</p>
          </div>
        </div>
      </div>

      <!-- Step 2: Scan QR Code -->
      <div class="mb-8">
        <div class="flex items-center mb-4">
          <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">2</div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">QRコードをスキャン</h3>
        </div>
        <div class="bg-gray-50 dark:bg-gray-700 rounded-2xl p-6 text-center">
          <div class="bg-white rounded-xl p-4 inline-block mb-4 shadow-sm">
            <%= raw @qr_code %>
          </div>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">認証アプリでこのQRコードをスキャンしてください</p>
          
          <!-- Manual Entry -->
          <details class="text-left">
            <summary class="cursor-pointer text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 text-sm font-medium">手動入力する場合はこちら</summary>
            <div class="mt-3 p-3 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-600">
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">以下のキーを手動で入力してください：</p>
              <code class="block p-2 bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded text-sm font-mono break-all"><%= @secret %></code>
            </div>
          </details>
        </div>
      </div>

      <!-- Step 3: Verify Code -->
      <div>
        <div class="flex items-center mb-4">
          <div class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold mr-3">3</div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-gray-100">認証コードを入力</h3>
        </div>
        <p class="text-gray-600 dark:text-gray-300 mb-4">認証アプリに表示された6桁のコードを入力して設定を完了してください</p>
        
        <%= form_with url: users_two_factor_authentications_path, method: :post, local: true, class: "space-y-4" do |form| %>
          <div>
            <label for="totp_code" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">認証コード</label>
            <input type="text" 
                   id="totp_code" 
                   name="totp_code" 
                   maxlength="6" 
                   pattern="[0-9]{6}"
                   placeholder="123456"
                   autocomplete="one-time-code"
                   class="block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-xl shadow-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-center text-lg font-mono bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100"
                   required>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">6桁の数字を入力してください</p>
          </div>
          
          <div class="flex flex-col sm:flex-row gap-4">
            <%= form.submit "二段階認証を有効にする", 
                  class: "flex-1 bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" %>
            
            <%= link_to "キャンセル", account_path,
                  class: "flex-1 bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500 text-gray-800 dark:text-gray-200 font-medium py-3 px-6 rounded-xl transition-colors duration-200 text-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500" %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Security Notice -->
    <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700/30 rounded-2xl p-6">
      <div class="flex items-center space-x-2 mb-3">
        <svg width="20" height="20" viewBox="0 0 24 24" class="text-yellow-600">
          <path fill="currentColor" d="M13,13H11V7H13M12,17.3A1.3,1.3 0 0,1 10.7,16A1.3,1.3 0 0,1 12,14.7A1.3,1.3 0 0,1 13.3,16A1.3,1.3 0 0,1 12,17.3M15.73,3H8.27L3,8.27V15.73L8.27,21H15.73L21,15.73V8.27L15.73,3Z"/>
        </svg>
        <h4 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200">重要な注意事項</h4>
      </div>
      <ul class="space-y-2 text-sm text-yellow-700 dark:text-yellow-300">
        <li class="flex items-start space-x-2">
          <span class="w-1.5 h-1.5 bg-yellow-500 dark:bg-yellow-400 rounded-full mt-2 flex-shrink-0"></span>
          <span>二段階認証を有効にすると、ログイン時に認証アプリからのコードが必要になります</span>
        </li>
        <li class="flex items-start space-x-2">
          <span class="w-1.5 h-1.5 bg-yellow-500 dark:bg-yellow-400 rounded-full mt-2 flex-shrink-0"></span>
          <span>設定完了後にバックアップコードが発行されます。安全な場所に保管してください</span>
        </li>
        <li class="flex items-start space-x-2">
          <span class="w-1.5 h-1.5 bg-yellow-500 dark:bg-yellow-400 rounded-full mt-2 flex-shrink-0"></span>
          <span>スマートフォンを紛失した場合はバックアップコードでログインできます</span>
        </li>
      </ul>
    </div>
  </div>
</div>

<script>
  // Auto-submit when 6 digits are entered
  document.getElementById('totp_code').addEventListener('input', function(e) {
    const value = e.target.value;
    if (value.length === 6 && /^\d{6}$/.test(value)) {
      // Auto-submit after a short delay to allow user to see the complete code
      setTimeout(() => {
        e.target.closest('form').submit();
      }, 500);
    }
  });
  
  // Prevent non-numeric input
  document.getElementById('totp_code').addEventListener('keypress', function(e) {
    if (!/\d/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'Enter'].includes(e.key)) {
      e.preventDefault();
    }
  });
</script>