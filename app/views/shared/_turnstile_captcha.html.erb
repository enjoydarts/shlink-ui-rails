<%# Cloudflare Turnstile CAPTCHA Widget %>
<% if CaptchaHelper.enabled? %>
  <div class="space-y-3 pt-4">
    <label class="block text-sm font-semibold text-gray-700 mb-3">
      ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼
    </label>
    
    <!-- Turnstile Widget Container -->
    <div id="turnstile-container" class="flex justify-center">
    </div>


    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div id="turnstile-error" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
      <div class="flex items-center space-x-2">
        <svg class="w-4 h-4 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.962-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
        </svg>
        <span id="turnstile-error-message" class="text-sm text-red-700"></span>
      </div>
    </div>

    <p class="text-sm text-gray-500 flex items-center space-x-1">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <span>ã“ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã¯ã€è‡ªå‹•åŒ–ã•ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²ããŸã‚ã®ã‚‚ã®ã§ã™</span>
    </p>
  </div>

  <script>
    // è¶…ã‚·ãƒ³ãƒ—ãƒ«ãªTurnstileç®¡ç† - ç«¶åˆã‚’å®Œå…¨å›é¿
    window.TurnstileController = window.TurnstileController || {
      widgetId: null,
      isInitializing: false,
      
      // ä¸€åº¦ã ã‘ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¨­å®š
      setupCallbacks: function() {
        if (window.onTurnstileSuccess) return;
        
        window.onTurnstileSuccess = function(token) {
          console.log('Turnstile success callback triggered, token length:', token.length);
          
          const tokenInput = document.querySelector('#turnstile-token, #turnstile-token-reg');
          if (tokenInput) {
            tokenInput.value = token;
            console.log('Token set in input field');
          } else {
            console.error('Token input field not found');
          }
          
          const errorDiv = document.getElementById('turnstile-error');
          if (errorDiv) errorDiv.classList.add('hidden');

          const submitButton = document.querySelector('button[type="submit"]');
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            console.log('Submit button enabled');
          } else {
            console.error('Submit button not found');
          }
        };

        window.onTurnstileError = function(error) {
          TurnstileController.showError('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        };

        window.onTurnstileExpired = function() {
          TurnstileController.showError('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚å†åº¦æ¤œè¨¼ã—ã¦ãã ã•ã„ã€‚');
        };
      },

      showError: function(message) {
        const errorDiv = document.getElementById('turnstile-error');
        const errorMessage = document.getElementById('turnstile-error-message');
        
        if (errorDiv && errorMessage) {
          errorMessage.textContent = message;
          errorDiv.classList.remove('hidden');
        }

        const submitButton = document.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
      },
      
      clean: function() {
        console.log('Cleaning Turnstile widget, current ID:', this.widgetId);
        if (this.widgetId !== null && window.turnstile) {
          try {
            window.turnstile.remove(this.widgetId);
            console.log('Turnstile widget removed');
          } catch (e) {
            console.log('Failed to remove widget:', e);
          }
          this.widgetId = null;
        }
        const container = document.getElementById('turnstile-container');
        if (container) container.innerHTML = '';
        this.isInitializing = false;
      },
      
      init: function() {
        const container = document.getElementById('turnstile-container');
        if (!container) {
          console.log('No Turnstile container found');
          return;
        }
        
        // DOMè¦ç´ ãŒå®Ÿéš›ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if (container.offsetParent === null && container.style.display !== 'block') {
          console.log('Turnstile container is not visible, retrying...');
          setTimeout(() => this.init(), 500);
          return;
        }
        
        // ã‚³ãƒ³ãƒ†ãƒŠãŒç©ºã®å ´åˆã¯åˆæœŸåŒ–ãŒå¿…è¦
        const existingWidget = container.querySelector('.cf-turnstile');
        if (this.widgetId !== null && existingWidget) {
          console.log('Turnstile already initialized with widget ID:', this.widgetId);
          // ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã®çŠ¶æ…‹ã‚’ç¢ºèª
          if (window.turnstile && typeof window.turnstile.getResponse === 'function') {
            try {
              const response = window.turnstile.getResponse(this.widgetId);
              console.log('Current widget response:', response ? 'has token' : 'no token');
            } catch (e) {
              console.log('Widget state check failed, reinitializing:', e);
              this.clean();
            }
          }
          return;
        }
        
        // æ–°ã—ã„ãƒšãƒ¼ã‚¸ï¼ˆã‚³ãƒ³ãƒ†ãƒŠãŒç©ºï¼‰ã®å ´åˆã¯å¼·åˆ¶åˆæœŸåŒ–
        if (!existingWidget) {
          console.log('Empty container detected - forcing initialization');
          this.clean(); // æ—¢å­˜ã®çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
        }
        
        // åˆæœŸåŒ–ä¸­ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        if (this.isInitializing) {
          console.log('Turnstile initialization already in progress');
          return;
        }
        
        this.isInitializing = true;
        console.log('Starting Turnstile initialization');
        this.setupCallbacks();
        
        // Turnstile APIãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
        const waitForAPI = () => {
          if (!window.turnstile || !window.turnstile.render) {
            setTimeout(waitForAPI, 100);
            return;
          }
          
          this.clean();
          
          const widget = document.createElement('div');
          widget.className = 'cf-turnstile';
          container.appendChild(widget);
          
          try {
            this.widgetId = window.turnstile.render(widget, {
              sitekey: '<%= Settings.captcha.turnstile.site_key.to_s %>',
              theme: 'auto',
              size: 'normal',
              callback: 'onTurnstileSuccess',
              'error-callback': 'onTurnstileError',
              'expired-callback': 'onTurnstileExpired'
            });
            
            console.log('Turnstile widget rendered with ID:', this.widgetId);
            
            // Turnstileã®çŠ¶æ…‹ã‚’å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯
            const checkTurnstileState = () => {
              if (window.turnstile && this.widgetId !== null) {
                try {
                  const response = window.turnstile.getResponse(this.widgetId);
                  if (response) {
                    console.log('Turnstile completed automatically, triggering success');
                    window.onTurnstileSuccess(response);
                    return;
                  }
                } catch (e) {
                  // getResponseãŒåˆ©ç”¨ã§ããªã„å ´åˆã¯ç„¡è¦–
                }
              }
              
              // 30ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
              if (Date.now() - this.renderTime > 30000) {
                console.log('Turnstile timeout - enabling form anyway');
                const submitButton = document.querySelector('button[type="submit"]');
                if (submitButton) {
                  submitButton.disabled = false;
                  submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                return;
              }
              
              // 1ç§’å¾Œã«å†ãƒã‚§ãƒƒã‚¯
              setTimeout(checkTurnstileState, 1000);
            };
            
            this.renderTime = Date.now();
            setTimeout(checkTurnstileState, 2000);
            
            // åˆæœŸçŠ¶æ…‹è¨­å®š
            const tokenInput = document.querySelector('#turnstile-token, #turnstile-token-reg');
            if (tokenInput) tokenInput.value = '';
            
            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton && '<%= Rails.env.test? %>' === 'false') {
              submitButton.disabled = true;
              submitButton.classList.add('opacity-50', 'cursor-not-allowed');
              console.log('Submit button disabled until CAPTCHA completion');
              
              // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®æ¤œè¨¼ã‚’è¿½åŠ 
              const form = submitButton.closest('form');
              if (form && !form.hasAttribute('data-turnstile-validated')) {
                form.setAttribute('data-turnstile-validated', 'true');
                form.addEventListener('submit', function(e) {
                  const tokenInput = document.querySelector('#turnstile-token, #turnstile-token-reg');
                  if (!tokenInput?.value) {
                    e.preventDefault();
                    TurnstileController.showError('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚');
                    return false;
                  }
                });
              }
            }
            
          } catch (e) {
            console.error('Turnstile render failed:', e);
          }
          
          this.isInitializing = false;
        };
        
        waitForAPI();
      }
    };
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOMContentLoaded - initializing Turnstile');
      TurnstileController.init();
    });
    
    document.addEventListener('turbo:load', () => {
      console.log('turbo:load - initializing Turnstile');
      // å°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«åˆæœŸåŒ–
      setTimeout(() => TurnstileController.init(), 100);
    });
    
    document.addEventListener('turbo:render', () => {
      console.log('turbo:render - initializing Turnstile');
      setTimeout(() => TurnstileController.init(), 100);
    });
    
    document.addEventListener('turbo:frame-load', () => {
      console.log('turbo:frame-load - initializing Turnstile');
      setTimeout(() => TurnstileController.init(), 100);
    });
    
    // ãƒšãƒ¼ã‚¸ã®è¡¨ç¤ºãŒå®Œäº†ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã‚‚åˆæœŸåŒ–ã‚’è©¦è¡Œ
    document.addEventListener('turbo:before-cache', () => {
      console.log('turbo:before-cache - cleaning Turnstile');
      TurnstileController.clean();
    });
    
    document.addEventListener('turbo:before-visit', () => {
      console.log('turbo:before-visit - cleaning Turnstile');
      TurnstileController.clean();
    });
    
    // ãƒšãƒ¼ã‚¸é·ç§»å¾Œã®è¡¨ç¤ºå®Œäº†æ™‚ã«ã‚‚åˆæœŸåŒ–
    document.addEventListener('turbo:visit', () => {
      console.log('turbo:visit - preparing for Turnstile');
    });
    
    // Mutation Observerã§ã‚³ãƒ³ãƒ†ãƒŠã®å‡ºç¾ã‚’ç›£è¦–
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList') {
          mutation.addedNodes.forEach((node) => {
            if (node.nodeType === Node.ELEMENT_NODE) {
              const container = node.querySelector ? node.querySelector('#turnstile-container') : null;
              if (container || node.id === 'turnstile-container') {
                console.log('Turnstile container detected via MutationObserver');
                setTimeout(() => TurnstileController.init(), 200);
              }
            }
          });
        }
      });
    });
    
    // bodyè¦ç´ ã®å¤‰æ›´ã‚’ç›£è¦–
    if (document.body) {
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });
    }
  </script>
  
<% end %>
<%# ç’°å¢ƒå¤‰æ•°ãŒãªã„å ´åˆã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„ï¼ˆCAPTCHAæ©Ÿèƒ½ãŒãªã„ã‚‚ã®ã¨ã—ã¦æ‰±ã†ï¼‰ %>