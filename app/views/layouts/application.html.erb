<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Shlink-UI-Rails" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%# 認証ページでは完全キャッシュ無効化 %>
    <% if devise_controller? %>
      <meta name="turbo-cache-control" content="no-cache">
      <meta name="cache-control" content="no-cache, no-store, must-revalidate">
      <meta name="pragma" content="no-cache">
      <meta name="expires" content="0">
    <% else %>
      <meta name="turbo-cache-control" content="no-cache">
    <% end %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon-16x16.png" sizes="16x16" type="image/png">
    <link rel="icon" href="/favicon-32x32.png" sizes="32x32" type="image/png">
    <link rel="icon" href="<%= asset_path('favicon.svg') %>" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/favicon-32x32.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= stylesheet_link_tag "tailwind", "data-turbo-track": "reload" %>

    <%# Chart.js for statistics charts %>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <%# Cloudflare Turnstile for CAPTCHA (認証ページでのみ読み込み) %>
    <% if devise_controller? && CaptchaHelper.enabled? %>
      <script>
        // Turnstileコールバックを先に定義
        window.onTurnstileLoad = function() {
          if (window.SimpleTurnstile) {
            console.log('Turnstile API loaded, initializing SimpleTurnstile');
            window.SimpleTurnstile.isReady = true;
            window.SimpleTurnstile.renderWidget();
          }
        };
      </script>
      <script src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=onTurnstileLoad" async defer></script>
    <% end %>

    <%= javascript_importmap_tags %>
  </head>

  <body data-turbo-action="replace">
    <!-- Navigation Bar -->
    <% if user_signed_in? %>
      <nav class="bg-white/90 backdrop-blur-sm border-b border-gray-200 sticky top-0 z-50" data-controller="mobile-menu" data-action="click@window->mobile-menu#closeOnOutsideClick keydown@window->mobile-menu#closeOnEscape">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex justify-between items-center h-16">
            <!-- Logo -->
            <div class="flex items-center">
              <%= link_to root_path, class: "flex items-center space-x-2" do %>
                <div class="w-8 h-8 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.102m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                  </svg>
                </div>
                <span class="font-bold text-gray-900">Shlink-UI-Rails</span>
              <% end %>
            </div>

            <!-- Desktop Navigation Links -->
            <div class="hidden md:flex items-center bg-gray-100 rounded-xl p-1">
              <%= link_to dashboard_path, class: nav_link_class('dashboard') do %>
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                URL作成
              <% end %>
              <%= link_to mypage_path, class: nav_link_class('mypage') do %>
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                マイページ
              <% end %>
            </div>

            <!-- Desktop User Menu -->
            <div class="hidden md:flex items-center space-x-4">
              <!-- User Dropdown Menu -->
              <div class="relative" data-controller="user-menu" data-action="click@window->user-menu#outsideClick keydown@window->user-menu#keydown">
                <button type="button"
                        data-action="click->user-menu#toggle"
                        class="flex items-center space-x-3 px-3 py-2 rounded-xl bg-gray-50 hover:bg-gray-100 transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                  <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center">
                    <span class="text-white text-sm font-semibold">
                      <%= current_user.display_name.first.upcase %>
                    </span>
                  </div>
                  <div class="text-sm text-left">
                    <p class="text-gray-900 font-medium"><%= current_user.display_name %></p>
                    <% if current_user.admin? %>
                      <p class="text-gray-500">管理者ユーザ</p>
                    <% end %>
                  </div>
                  <svg class="w-4 h-4 text-gray-500 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>

                <!-- Dropdown Menu -->
                <div data-user-menu-target="dropdown"
                     class="hidden opacity-0 scale-95 absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-lg border border-gray-200 transform transition-all duration-150 ease-out z-50">
                  <div class="py-2">
                    <!-- Account Settings -->
                    <%= link_to account_path,
                          class: "flex items-center space-x-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors duration-200" do %>
                      <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      </svg>
                      <span class="font-medium">アカウント設定</span>
                    <% end %>

                    <!-- Admin Panel Link (Only for admin users) -->
                    <% if current_user.admin? %>
                      <%= link_to admin_dashboard_path,
                            class: "flex items-center space-x-3 px-4 py-3 text-sm text-gray-700 hover:bg-gray-50 transition-colors duration-200" do %>
                        <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                        </svg>
                        <span class="font-medium">管理者パネル</span>
                      <% end %>
                    <% end %>

                    <!-- Divider -->
                    <div class="border-t border-gray-100 my-1"></div>

                    <!-- Logout -->
                    <%= button_to destroy_user_session_path, method: :delete,
                          class: "w-full flex items-center space-x-3 px-4 py-3 text-sm text-red-600 hover:bg-red-50 transition-colors duration-200 text-left",
                          data: { confirm: "ログアウトしますか？" } do %>
                      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                      </svg>
                      <span class="font-medium">ログアウト</span>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Mobile Hamburger Button -->
            <div class="md:hidden">
              <button type="button"
                      data-action="click->mobile-menu#toggle"
                      class="inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-gray-900 hover:bg-gray-100 transition-colors duration-200">
                <span class="sr-only">メニューを開く</span>
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
              </button>
            </div>
          </div>
        </div>

        <!-- Mobile Menu -->
        <div class="md:hidden hidden opacity-0 -translate-y-2 transition-all duration-200 ease-out bg-white border-t border-gray-200" data-mobile-menu-target="menu">
          <div class="px-4 py-3 space-y-3">
            <!-- Mobile Navigation Links -->
            <div class="space-y-2">
              <%= link_to dashboard_path, class: "flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200" do %>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                <span class="font-medium">URL作成</span>
              <% end %>
              <%= link_to mypage_path, class: "flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200" do %>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                <span class="font-medium">マイページ</span>
              <% end %>
              <%= link_to account_path, class: "flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200" do %>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <span class="font-medium">アカウント設定</span>
              <% end %>

              <!-- Admin Panel Link for Mobile (Only for admin users) -->
              <% if current_user.admin? %>
                <%= link_to admin_dashboard_path, class: "flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-700 hover:bg-gray-100 transition-colors duration-200" do %>
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                  </svg>
                  <span class="font-medium">🔧 管理者パネル</span>
                <% end %>
              <% end %>
            </div>

            <!-- Mobile User Info -->
            <div class="border-t border-gray-200 pt-3">
              <div class="flex items-center space-x-3 px-3 py-2">
                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                  <span class="text-white font-semibold">
                    <%= current_user.display_name.first.upcase %>
                  </span>
                </div>
                <div>
                  <p class="text-gray-900 font-medium"><%= current_user.display_name %></p>
                  <% if current_user.admin? %>
                    <p class="text-gray-500 text-sm">管理者ユーザ</p>
                  <% end %>
                </div>
              </div>

              <!-- Mobile Logout Button -->
              <%= button_to destroy_user_session_path, method: :delete,
                    class: "w-full flex items-center justify-center space-x-2 px-3 py-2 mt-2 bg-red-600 hover:bg-red-700 text-white font-medium rounded-lg transition-colors duration-200",
                    data: { confirm: "ログアウトしますか？" } do %>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                </svg>
                <span>ログアウト</span>
              <% end %>
            </div>
          </div>
        </div>
      </nav>
    <% end %>

    <!-- Flash Messages -->
    <%= render_flash_messages %>

    <%= yield %>
  </body>
</html>
