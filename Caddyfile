# Caddyfile
# Caddy Web Server設定ファイル（本番環境用）
#
# このファイルは本番サーバーの /etc/caddy/Caddyfile としてコピーして使用します。
# app.kety.at ドメインでのHTTPS自動化とリバースプロキシ設定を行います。

# メインサイト設定
app.kety.at {
	# Railsアプリケーションへのリバースプロキシ
	reverse_proxy localhost:3000 {
		# ヘルスチェック設定
		health_uri /health
		health_interval 10s
		health_timeout 5s
		health_passes 2
		health_fails 3

		# 失敗時の再試行設定
		fail_duration 30s
		max_fails 3

		# タイムアウト設定
		transport http {
			dial_timeout 10s
			response_header_timeout 30s
		}

		# ヘッダー転送設定
		header_up Host {upstream_hostport}
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Port {server_port}
	}

	# セキュリティヘッダー設定
	header {
		# HTTPS強制（HSTS）
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

		# XSS対策
		X-Content-Type-Options "nosniff"
		X-Frame-Options "SAMEORIGIN"
		X-XSS-Protection "1; mode=block"

		# リファラー制御
		Referrer-Policy "strict-origin-when-cross-origin"

		# Content Security Policy（Railsアプリに合わせて調整）
		Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://apis.google.com https://challenges.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-src https://accounts.google.com https://challenges.cloudflare.com; worker-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self';"

		# 権限ポリシー
		Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=()"

		# サーバー情報隠蔽
		-Server
		-X-Powered-By
	}

	# レート制限設定
	rate_limit {
		zone general {
			key {remote_host}
			events 100
			window 1m
		}

		zone login {
			key {remote_host}
			events 5
			window 1m
		}

		zone api {
			key {remote_host}
			events 60
			window 1m
		}
	}

	# パス別の設定

	# ログインページのレート制限強化
	@login path /users/sign_in /users/sign_up /users/password
	rate_limit @login login

	# API エンドポイントのレート制限
	@api path /api/*
	rate_limit @api api

	# 静的アセットのキャッシュ設定
	@assets path /assets/* /packs/* /images/* /stylesheets/* /javascripts/*
	header @assets {
		Cache-Control "public, max-age=31536000, immutable"
	}

	# ファビコンのキャッシュ
	@favicon path /favicon.ico /apple-touch-icon*.png /android-chrome-*.png
	header @favicon {
		Cache-Control "public, max-age=86400"
	}

	# robots.txt とsitemap.xmlのキャッシュ
	@seo path /robots.txt /sitemap.xml
	header @seo {
		Cache-Control "public, max-age=3600"
	}

	# ログ設定
	log {
		# ログファイル出力設定
		output file /var/log/caddy/app.kety.at.log {
			# ローテーション設定
			roll_size 100MB
			roll_keep 10
			roll_keep_days 30
		}

		# JSON形式での構造化ログ
		format json

		# ログレベル設定
		level INFO

		# 除外するパス（ヘルスチェックなど）
		exclude http.request.uri.path /health
	}

	# アクセスログ設定
	log access {
		output file /var/log/caddy/access.log {
			roll_size 100MB
			roll_keep 5
		}
		format json {
			time_format "2006-01-02T15:04:05Z07:00"
			message_key "msg"
		}
		include http.request.remote_ip
		include http.request.host
		include http.request.method
		include http.request.uri
		include http.response.status
		include http.response.size
		include http.request.duration
		include http.request.headers.User-Agent
		include http.request.headers.Referer
	}

	# エラーページ設定
	handle_errors {
		# 404エラー
		@404 expression {http.error.status_code} == 404
		handle @404 {
			respond "Page Not Found" 404
		}

		# 5xxサーバーエラー
		@5xx expression {http.error.status_code} >= 500 && {http.error.status_code} < 600
		handle @5xx {
			respond "Internal Server Error" 500
		}

		# 429 Too Many Requests
		@429 expression {http.error.status_code} == 429
		handle @429 {
			respond "Too Many Requests" 429
		}
	}

	# Gzip圧縮設定
	encode {
		gzip 6
		# 対象ファイルタイプ
		match {
			header Content-Type text/*
			header Content-Type application/json*
			header Content-Type application/javascript*
			header Content-Type application/xml*
		}
		# 最小サイズ（小さすぎるファイルは圧縮しない）
		minimum_length 1024
	}

	# セキュリティ設定: 不要な情報の露出防止
	@hidden {
		path /.env* /.git* /config/* /tmp/* /log/*
		path /Dockerfile* /docker-compose* /.docker*
		path /.bundle/* /vendor/bundle/*
	}
	handle @hidden {
		respond "Not Found" 404
	}
}

# HTTPリダイレクト（Caddyが自動で行うが、明示的に記載）
http://app.kety.at {
	# HTTPS強制リダイレクト
	redir https://app.kety.at{uri} permanent
}

# グローバル設定
{
	# サーバー名設定
	servers {
		name app-server
		listener_wrappers {
			tls
		}
	}

	# TLS設定
	tls {
		# Let's Encrypt設定
		issuer acme {
			dir https://acme-v02.api.letsencrypt.org/directory
			email admin@kety.at
		}

		# TLSバージョン制限
		protocols tls1.2 tls1.3

		# 強力な暗号化スイート使用
		ciphers TLS_AES_256_GCM_SHA384 TLS_CHACHA20_POLY1305_SHA256 TLS_AES_128_GCM_SHA256
	}

	# セキュリティ設定
	servers :443 {
		# DDoS対策
		timeouts {
			read_body   10s
			read_header 10s
			write       60s
			idle        300s
		}

		# 最大リクエストサイズ
		max_header_bytes 10KB
	}
}